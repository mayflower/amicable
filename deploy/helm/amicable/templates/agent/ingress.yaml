{{- if .Values.agent.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: amicable-agent
  namespace: {{ .Release.Namespace | quote }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    {{- $agent := (index .Values "agent" | default dict) }}
    {{- $ingress := (index $agent "ingress" | default dict) }}
    {{- $traefik := (index $ingress "traefik" | default dict) }}
    {{- $forceHttp1 := (index $traefik "forceHttp1" | default dict) }}
    {{- if (index $forceHttp1 "enabled" | default false) }}
    # Browsers' WebSocket API uses the HTTP/1.1 Upgrade handshake (not RFC 8441),
    # so if ALPN negotiates h2-only, WebSockets will fail before reaching the agent.
    {{- $tlsOptionName := (index $forceHttp1 "tlsOptionName" | default "amicable-agent-http1") }}
    traefik.ingress.kubernetes.io/router.tls.options: {{ printf "%s@kubernetescrd" $tlsOptionName | quote }}
    {{- end }}
    cert-manager.io/cluster-issuer: {{ .Values.agent.ingress.certIssuer | quote }}
spec:
  ingressClassName: {{ .Values.agent.ingress.ingressClassName | quote }}
  {{- if .Values.agent.ingress.tls.enabled }}
  tls:
    - hosts:
        - {{ .Values.agent.ingress.host | quote }}
      secretName: {{ .Values.agent.ingress.tls.secretName | quote }}
  {{- end }}
  rules:
    - host: {{ .Values.agent.ingress.host | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: amicable-agent
                port:
                  number: {{ .Values.agent.service.port }}
{{- end }}
