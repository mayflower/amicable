apiVersion: v1
kind: ConfigMap
metadata:
  name: amicable-preview-router-nginx
  namespace: {{ .Release.Namespace | quote }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    http {
      resolver kube-dns.kube-system.svc.cluster.local valid=5s ipv6=off;

      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }

      # Cache for slug -> sandbox_id resolution.
      proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=resolve_cache:10m max_size=100m inactive=10m use_temp_path=off;

      # Extract slug (first DNS label) from: <slug>.{{ .Values.agent.env.previewBaseDomain }}
      #
      # We intentionally do this via `map` so we can use `server_name _;` (no regex).
      # This avoids nginx config parse pitfalls around regex server_name syntax across builds.
      map $host $slug {
        default "";
        # Use `*` quantifier instead of `{m,n}` to avoid nginx parse issues in some builds.
        ~^([a-z0-9]([-a-z0-9]*[a-z0-9])?)\.{{ .Values.agent.env.previewBaseDomain | replace "." "\\." }}$ $1;
      }

      server {
        listen 80;
        server_name _;

        if ($slug = "") { return 404; }

        # Internal resolver call (to the agent) used by auth_request.
        location = /__resolve_sandbox {
          internal;

          proxy_cache resolve_cache;
          proxy_cache_key $host;
          proxy_cache_valid 200 10m;
          proxy_cache_valid 401 30s;
          proxy_cache_valid 500 5s;
          proxy_cache_valid 502 5s;
          proxy_cache_valid 503 5s;

          # Translate resolver 404 -> 401 so auth_request can handle it, then the
          # public location maps 401 -> 404 via error_page.
          proxy_intercept_errors on;
          error_page 404 =401 /__resolve_not_found;

          proxy_http_version 1.1;
          proxy_set_header Connection "";

          proxy_set_header X-Amicable-Preview-Token {{ (index .Values.agent.env.extra "PREVIEW_RESOLVER_TOKEN") | default "" | quote }};
          proxy_pass http://amicable-agent.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.agent.service.port }}/internal/preview/resolve?host=$host;
        }

        location = /__resolve_not_found {
          internal;
          return 401;
        }

        location = /__not_found {
          internal;
          return 404;
        }

        location / {
          auth_request /__resolve_sandbox;
          auth_request_set $sandbox_id $upstream_http_x_amicable_sandbox_id;

          # Missing slug->sandbox mapping should return 404 to the browser.
          error_page 401 =404 /__not_found;

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
          proxy_set_header X-Forwarded-For $remote_addr;

          proxy_read_timeout 3600s;
          proxy_send_timeout 3600s;

          proxy_pass http://$sandbox_id.{{ .Values.sandboxNamespace }}.svc.cluster.local:3000;
        }
      }
    }
