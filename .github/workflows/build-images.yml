name: Build and Publish Images (GHCR)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:

permissions:
  contents: read
  packages: write

concurrency:
  group: ghcr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: amicable-agent
            dockerfile: k8s/images/amicable-agent/Dockerfile
          - name: amicable-sandbox
            dockerfile: k8s/images/amicable-sandbox/Dockerfile
          - name: amicable-sandbox-lovable-vite
            dockerfile: k8s/images/amicable-sandbox-lovable-vite/Dockerfile
          - name: amicable-sandbox-nextjs15
            dockerfile: k8s/images/amicable-sandbox-nextjs15/Dockerfile
          - name: amicable-sandbox-fastapi
            dockerfile: k8s/images/amicable-sandbox-fastapi/Dockerfile
          - name: amicable-sandbox-hono
            dockerfile: k8s/images/amicable-sandbox-hono/Dockerfile
          - name: amicable-sandbox-remix
            dockerfile: k8s/images/amicable-sandbox-remix/Dockerfile
          - name: amicable-sandbox-nuxt3
            dockerfile: k8s/images/amicable-sandbox-nuxt3/Dockerfile
          - name: amicable-sandbox-sveltekit
            dockerfile: k8s/images/amicable-sandbox-sveltekit/Dockerfile
          - name: amicable-sandbox-laravel
            dockerfile: k8s/images/amicable-sandbox-laravel/Dockerfile
          - name: amicable-sandbox-flutter
            dockerfile: k8s/images/amicable-sandbox-flutter/Dockerfile
          - name: amicable-sandbox-phoenix
            dockerfile: k8s/images/amicable-sandbox-phoenix/Dockerfile
          - name: amicable-sandbox-aspnetcore
            dockerfile: k8s/images/amicable-sandbox-aspnetcore/Dockerfile
          - name: amicable-sandbox-quarkus
            dockerfile: k8s/images/amicable-sandbox-quarkus/Dockerfile
          - name: amicable-editor
            dockerfile: k8s/images/amicable-editor/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}
          tags: |
            type=sha,format=short,prefix=sha-
            type=ref,event=branch
            type=ref,event=tag

      - name: Build (PR)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  promote-staging:
    name: Deploy staging via ArgoCD
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: mayflower-k8s-runners
    steps:
      - name: Install ArgoCD CLI
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.local/bin"
          curl -sSL -o "${HOME}/.local/bin/argocd" \
            "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64"
          chmod +x "${HOME}/.local/bin/argocd"
          echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"
          "${HOME}/.local/bin/argocd" version --client

      - name: Set image tags and sync
        env:
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          ARGOCD_SERVER: argocd-server.argocd.svc.cluster.local
          ARGOCD_OPTS: "--grpc-web --plaintext"
        run: |
          set -euo pipefail

          IMAGE_TAG="sha-${GITHUB_SHA::7}"
          APP="amicable-staging"
          # Source position 3 = main Helm chart (1=values ref, 2=pre-setup, 3=main chart)
          POS="--source-position 3"

          echo "Deploying ${IMAGE_TAG} to ${APP}"

          argocd app set "${APP}" ${POS} \
            -p images.agent.tag="${IMAGE_TAG}" \
            -p images.sandbox.tag="${IMAGE_TAG}" \
            -p images.editor.tag="${IMAGE_TAG}" \
            -p "sandboxTemplates[0].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[1].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[2].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[3].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[4].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[5].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[6].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[7].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[8].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[9].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[10].image.tag=${IMAGE_TAG}" \
            -p "sandboxTemplates[11].image.tag=${IMAGE_TAG}"

          argocd app sync "${APP}" --prune --timeout 300
          argocd app wait "${APP}" --timeout 300
